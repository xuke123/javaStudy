# 2pc提交与3pc提交

## 2PC协议，叫两阶段提交协议(Two-phase Commit)

简单些来说：

### 第一阶段：表决（请求阶段）

事务协调者通知每个参与者准备提交或取消事务，然后进入表决过程，参与者要么在本地执行事务，但不提交；参与者将告知协调者自己的决策: 同意或取消

- 事务询问
- 执行事务
- 各参与者协调者反馈事务询问的响应

### 第二阶段：执行（提交阶段）

此时，协调者将基于请求阶段的投票结果进行决策: 提交或取消；当且仅当所有的参与者同意提交事务，协调者才通知所有的参与者提交事务，否则协调者将通知所有的参与者取消事务；参与者在接收到协调者发来的消息后将执行相应的操作

- 执行事务提交(所有参与这个反馈是Yes)
  - 发送提交请求
  - 事务提交
  - 反馈事务提交结果
  - 完成事务
- 中断事务
  - 发送回滚请求
  - 事务回滚
  - 反馈事务回滚结果

优点 简单,实现方便
缺点: 同步阻塞,单点问题,脑裂,保守

## 3PC协议

将提交事务一分为二,分为CanCommit PreCommit do Commit三个阶段

### 第一阶段 CanCommit

1. 事务查询
2. 各参与者向协调者反馈事务询问的响应

### 第二阶段 PreCommit

执行事务预提交

1. 发送预提交请求
2. 事务预提交
3. 个参与者向协调者反馈事务执行响应

中断事务

1. 发送中断请求
2务

### 第三阶段 doCommit

执行提交

1. 发送提交请求
2. 事务提交
3. 反馈事务提交结果
4. 完成事务

中断事务

1. 发送中断请求
2. 事务回滚
3. 反馈事务回滚结果
4. 中断事务

两种故障,协调者出现问题,协调者和参与者之间网络故障 参与者在等待超时后,会继续提交事务

优缺点:降低了拥塞,在单点故障时,仍能达成一致

参与者在percommit后出现网络分区故障,参与者仍会提交事务,必然导致数据不一致

### Paxos算法

少数服从多数原则,支持分布式角色之间轮换,极大地避免了单点问题