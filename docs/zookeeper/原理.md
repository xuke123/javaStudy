# [原理](https://zhuanlan.zhihu.com/p/64702090)

## 基本功能

文件系统+通知系统

### 1. 文件系统

一个类似文件系统的数据结构,可以自由的增加,删除znode节点,有四种类型的znode节点:

- 持久化目录节点, 客户端断开后,节点依旧存在
- 持久化顺序目录节点,在持久目录节点基础上,对各个节点进行顺序编号
- 临时目录节点,客户端断开后,节点被删除
- 临时顺序编号目录节点,在临时目录节点基础上,对节点名称进行顺序编号

### 2. 通知机制

客户端注册监听它关心的目录节点,目录节点发生变化时(数据改变,被删除,子目录节点增加删除时),zookeeper会通知客户端.

## zookeeper应用

### 1. 命名服务

zookeeper创建唯一目录(path),通过path即可相关发现,不见不散

### 2. 配置服务

多个应用监听配置节点变化,配置信息变更后,每个节点都可以收到zk的通知

### 3. 集群管理

- 机器退出,加入
- 选举master\
  所有机器创建临时顺序编号目录节点,每次选取编号最小的机器作为master就好

### 4. 分布式锁

两类锁服务,保持独占,控制时序

- 独占锁,所有节点都到相同目录下创建同一个节点,最终创建成功客户端拥有这边锁,用完删除节点,即删除锁
- 乐观锁,所有客户端的创建临时顺序目录节点,和选master一样,编号最小的获取锁,用完删除,依次...

### 5. 队列管理

同步队列和FIFO队列

- 同步队列,所有队列成员都聚齐时,队列可用,在约定目录下创建临时目录节点,监听节点数目是否超过要求的数目
- 入列有编号,出列按编号

## 分布式与数据复制
  
Zookeeper作为一个集群提供一致的数据服务，自然，它要在所有机器间做数据复制。​ 
对zookeeper来说，它采用的方式是写任意。通过增加机器，它的读吞吐能力和响应能力扩展性非常好，而写，随着机器的增多吞吐能力肯定下降（这 也是它建立observer的原因），而响应能力则取决于具体实现方式，是延迟复制保持最终一致性，还是立即复制快速响应。

## 数据一致性与paxos算法

在一个分布式数据库系统中，如果各节点的初始状态一致，每个节点都执行相同的操作序列，那么他们最后能得到一个一致的状态。

Paxos算法通过投票来对写操作进行全局编号，同一时刻，只有一个写操作被批准，同时并发的写操作要去争取选票，只有获得过半数选票的写操作才会被 批准（所以永远只会有一个写操作得到批准），其他的写操作竞争失败只好再发起一轮投票，就这样，在日复一日年复一年的投票中，所有写操作都被严格编号排 序。编号严格递增，当一个节点接受了一个编号为100的写操作，之后又接受到编号为99的写操作（因为网络延迟等很多不可预见原因），它马上能意识到自己 数据不一致了，自动停止对外服务并重启同步过程。任何一个节点挂掉都不会影响整个集群的数据一致性（总2n+1台，除非挂掉大于n台）。

 Zookeeper的核心是原子广播，这个机制保证了各个Server之间的同步。实现这个机制的协议叫做Zab协议。Zab协议有两种模式，它们分 别是恢复模式（选主）和广播模式（同步）。当服务启动或者在领导者崩溃后，Zab就进入了恢复模式，当领导者被选举出来，且大多数Server完成了和 leader的状态同步以后，恢复模式就结束了。状态同步保证了leader和Server具有相同的系统状态。

## ZooKeeper的工作原理

​ 为了保证事务的顺序一致性，zookeeper采用了递增的事务id号（zxid）来标识事务。所有的提议（proposal）都在被提出的时候加上 了zxid。实现中zxid是一个64位的数字，它高32位是epoch用来标识leader关系是否改变，每次一个leader被选出来，它都会有一个 新的epoch，标识当前属于那个leader的统治时期。低32位用于递增计数。

每个Server在工作过程中有三种状态：

LOOKING：当前Server不知道leader是谁，正在搜寻
LEADING：当前Server即为选举出来的leader
FOLLOWING：leader已经选举出来，当前Server与之同步

### 选举主流程

### 同步流程
