# 事件

<!-- TOC -->

- [事件](#事件)
  - [文件事件](#文件事件)
    - [主要流程图](#主要流程图)
  - [时间事件](#时间事件)
  - [事件调用和执行](#事件调用和执行)

<!-- /TOC -->

## 文件事件

客户端通过的套接字和服务器连接,套接字操作其实就是文件事件\
网络模型Reactor模式,redis基于该模式的处理器称之为文件事件处理器\
I/O的多路复用监听多个套接字,根据任务关联不同事件处理器\
_**文件事件处理器以单线程方式运行**_,但通过使用IO多路复用程序来监听多个套接字,文件事件处理器即保证了高性能网络通信模型,又能很多对接其他单线程模块,简单至上

### 主要流程图

![事件分配器](https://raw.githubusercontent.com/xuke123/tuChuang/master/20200712103529.png)

- 实现:redis允许在编译时选择性能最高的IO多路复用函数库
- 事件类型,可读可写,优先读,每次套接字变成可应答,可写或可读时,文件事件就产生
- 主要文件事件处理器:`连接应答处理器`/`命令请求处理器`/`命令回复处理器`/`复制处理器`
- 完整过程
  
  ![通信过程](https://raw.githubusercontent.com/xuke123/tuChuang/master/20200712104627.png)

## 时间事件

redis服务器中某些操作,需在给定时间点执行,时间事件就是服务器对这类定时操作抽象

- 分类:定时事件(只执行一次,redis未使用),周期性事件
- 主要属性: id,when,timeProc
- 实现: 所有时间事件放在无序链表(未按照时间排序),时间事件执行器运行时,遍历找到已到达时间事件,调用相应的事件处理器
- 目前redis 主要有serverCron一个时间事件,benchmark也只有两个,所以无序问题不大

serverCon时间事件

    主要工作
    
    - 更新服务器各类统计信息,如时间,内存占用,数据库占用情况
    - 清理数据库过期键值对
    - 关闭和清理连接失败的客户端
    - 尝试AOF和RDB持久化操作
    - 如果是主服务器,对从服务器定期同步
    - 集群模式,定期同步和连接测试
  
    执行周期:可配

## 事件调用和执行

概述图

![概述](https://raw.githubusercontent.com/xuke123/tuChuang/master/20200712110140.png)

注意点:

- 文件事件处理和时间事件处理是顺序执行的,不是分开的,不会互相抢占
- 时间事件处理器会将耗时严重操的放在子进程和子线程执行
- 时间事件处理器通常处理起来都是晚一点

